{% extends "base.html" %}

{% block title %}Reminders - Health Tracker{% endblock %}

{% block extra_css %}
<style>
.reminder-card {
    transition: transform 0.2s;
    border-radius: 1rem;
    overflow: hidden;
}

.reminder-card:hover {
    transform: translateY(-5px);
}

.reminder-type-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.reminder-type-water {
    background-color: #cfe2ff;
    color: #0d6efd;
}

.reminder-type-exercise {
    background-color: #d1e7dd;
    color: #198754;
}

.reminder-type-meal {
    background-color: #fff3cd;
    color: #ffc107;
}

.reminder-type-medicine {
    background-color: #f8d7da;
    color: #dc3545;
}

.reminder-type-weight {
    background-color: #e2e3e5;
    color: #6c757d;
}

.reminder-status {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.reminder-active {
    background-color: #198754;
}

.reminder-inactive {
    background-color: #6c757d;
}

.reminder-schedule {
    font-size: 0.9rem;
    color: #6c757d;
}

.reminder-schedule i {
    margin-right: 0.5rem;
}

.day-selector {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
}

.day-button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.day-button:hover {
    border-color: #198754;
    color: #198754;
}

.day-button.selected {
    background-color: #198754;
    border-color: #198754;
    color: white;
}

.time-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
}

.time-slot {
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    background-color: #f8f9fa;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
}

.time-slot:hover {
    background-color: #e9ecef;
}

.time-slot.selected {
    background-color: #198754;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Reminders</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReminderModal">
                    <i class="fas fa-plus me-2"></i>New Reminder
                </button>
            </div>
        </div>
    </div>

    <!-- Active Reminders -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Active Reminders</h5>
                    <div id="activeReminders">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminder Groups -->
    <div class="row">
        <!-- Water -->
        <div class="col-md-6 mb-4">
            <div class="card reminder-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="reminder-type-icon reminder-type-water">
                            <i class="fas fa-glass-water fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Water Reminders</h5>
                            <p class="card-text text-muted mb-0">Daily water intake tracking</p>
                        </div>
                    </div>
                    <div id="waterReminders">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise -->
        <div class="col-md-6 mb-4">
            <div class="card reminder-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="reminder-type-icon reminder-type-exercise">
                            <i class="fas fa-dumbbell fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Exercise Reminders</h5>
                            <p class="card-text text-muted mb-0">Exercise program tracking</p>
                        </div>
                    </div>
                    <div id="exerciseReminders">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Meals -->
        <div class="col-md-6 mb-4">
            <div class="card reminder-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="reminder-type-icon reminder-type-meal">
                            <i class="fas fa-utensils fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Meal Reminders</h5>
                            <p class="card-text text-muted mb-0">Regular nutrition tracking</p>
                        </div>
                    </div>
                    <div id="mealReminders">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements -->
        <div class="col-md-6 mb-4">
            <div class="card reminder-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="reminder-type-icon reminder-type-weight">
                            <i class="fas fa-weight-scale fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Measurement Reminders</h5>
                            <p class="card-text text-muted mb-0">Regular measurement tracking</p>
                        </div>
                    </div>
                    <div id="measurementReminders">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Reminder Modal -->
<div class="modal fade" id="addReminderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addReminderForm">
                    <div class="mb-3">
                        <label class="form-label">Reminder Type</label>
                        <select class="form-select" name="reminder_type" required>
                            <option value="water">Water Intake</option>
                            <option value="exercise">Exercise</option>
                            <option value="meal">Meal</option>
                            <option value="weight">Measurement</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Frequency</label>
                        <select class="form-select" name="frequency" required>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="mb-3" id="daySelector">
                        <label class="form-label">Days</label>
                        <div class="day-selector">
                            <div class="day-button" data-day="1">Mo</div>
                            <div class="day-button" data-day="2">Tu</div>
                            <div class="day-button" data-day="3">We</div>
                            <div class="day-button" data-day="4">Th</div>
                            <div class="day-button" data-day="5">Fr</div>
                            <div class="day-button" data-day="6">Sa</div>
                            <div class="day-button" data-day="0">Su</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" name="time" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remind Before</label>
                        <select class="form-select" name="remind_before">
                            <option value="0">At the exact time</option>
                            <option value="5">5 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60">1 hour before</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addReminderForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Add Reminder
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load reminders
    function loadReminders() {
        $.get('/api/reminders', function(data) {
            updateActiveReminders(data.active);
            updateReminderGroups(data.groups);
        });
    }

    // Update active reminders
    function updateActiveReminders(reminders) {
        const container = $('#activeReminders');
        container.empty();

        if (reminders.length === 0) {
            container.append(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-bell-slash fa-2x mb-2"></i>
                    <p>No active reminders</p>
                </div>
            `);
            return;
        }

        reminders.forEach(reminder => {
            container.append(`
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-center">
                                <div class="reminder-type-icon reminder-type-${reminder.type}">
                                    <i class="fas ${getReminderIcon(reminder.type)} fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">${reminder.title}</h6>
                                    <p class="mb-2 text-muted">${reminder.description || ''}</p>
                                    <div class="reminder-schedule">
                                        <i class="fas fa-clock"></i>${formatTime(reminder.time)}
                                        ${reminder.days ? `<i class="fas fa-calendar ms-3"></i>${formatDays(reminder.days)}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-outline-secondary me-2 toggle-reminder" 
                                        data-id="${reminder.id}">
                                    <i class="fas ${reminder.active ? 'fa-bell-slash' : 'fa-bell'}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-reminder" 
                                        data-id="${reminder.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        });
    }

    // Update reminder groups
    function updateReminderGroups(groups) {
        Object.entries(groups).forEach(([type, reminders]) => {
            const container = $(`#${type}Reminders`);
            container.empty();

            if (reminders.length === 0) {
                container.append(`
                    <div class="text-center text-muted py-3">
                        <p class="mb-0">No reminders in this category</p>
                    </div>
                `);
                return;
            }

            reminders.forEach(reminder => {
                container.append(`
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <div class="reminder-status ${reminder.active ? 'reminder-active' : 'reminder-inactive'}"></div>
                                <h6 class="mb-0">${reminder.title}</h6>
                            </div>
                            <div class="reminder-schedule">
                                <i class="fas fa-clock"></i>${formatTime(reminder.time)}
                                ${reminder.days ? `<i class="fas fa-calendar ms-3"></i>${formatDays(reminder.days)}` : ''}
                            </div>
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-sm btn-outline-secondary me-2 toggle-reminder" 
                                    data-id="${reminder.id}">
                                <i class="fas ${reminder.active ? 'fa-bell-slash' : 'fa-bell'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-reminder" 
                                    data-id="${reminder.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
        });
    }

    // Get reminder icon based on type
    function getReminderIcon(type) {
        const icons = {
            water: 'fa-glass-water',
            exercise: 'fa-dumbbell',
            meal: 'fa-utensils',
            weight: 'fa-weight-scale'
        };
        return icons[type] || 'fa-bell';
    }

    // Format time
    function formatTime(time) {
        return time;
    }

    // Format days
    function formatDays(days) {
        const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
        return days.map(d => dayNames[d]).join(', ');
    }

    // Add reminder
    $('#addReminderForm').submit(function(e) {
        e.preventDefault();
        const formData = {
            type: $('select[name="reminder_type"]').val(),
            title: $('input[name="title"]').val(),
            description: $('textarea[name="description"]').val(),
            frequency: $('select[name="frequency"]').val(),
            days: $('.day-button.selected').map(function() {
                return $(this).data('day');
            }).get(),
            time: $('input[name="time"]').val(),
            remind_before: parseInt($('select[name="remind_before"]').val())
        };

        $.ajax({
            url: '/api/reminders',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#addReminderModal').modal('hide');
                $('#addReminderForm')[0].reset();
                $('.day-button').removeClass('selected');
                loadReminders();
            }
        });
    });

    // Toggle reminder status
    $(document).on('click', '.toggle-reminder', function() {
        const id = $(this).data('id');
        $.ajax({
            url: `/api/reminders/${id}/toggle`,
            method: 'POST',
            success: loadReminders
        });
    });

    // Delete reminder
    $(document).on('click', '.delete-reminder', function() {
        const id = $(this).data('id');
        if (confirm('Are you sure you want to delete this reminder?')) {
            $.ajax({
                url: `/api/reminders/${id}`,
                method: 'DELETE',
                success: loadReminders
            });
        }
    });

    // Day selector
    $('.day-button').click(function() {
        $(this).toggleClass('selected');
    });

    // Show/hide day selector based on frequency
    $('select[name="frequency"]').change(function() {
        if ($(this).val() === 'custom') {
            $('#daySelector').show();
        } else {
            $('#daySelector').hide();
        }
    });

    // Set default time value
    const now = new Date();
    $('input[name="time"]').val(
        `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
    );

    // Initial load
    loadReminders();
});
</script>
{% endblock %} 