{% extends "base.html" %}

{% block title %}Beslenme Takibi - Sağlık Takip{% endblock %}

{% block extra_css %}
<style>
.meal-card {
    transition: transform 0.2s;
    border-radius: 1rem;
    overflow: hidden;
}

.meal-card:hover {
    transform: translateY(-5px);
}

.meal-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
}

.nutrition-stat {
    text-align: center;
    padding: 1rem;
    border-radius: 0.5rem;
    background: #f8f9fa;
    margin-bottom: 1rem;
}

.nutrition-stat i {
    font-size: 24px;
    margin-bottom: 0.5rem;
    color: #198754;
}

.nutrition-progress {
    height: 8px;
    border-radius: 4px;
    margin-top: 0.5rem;
}

.macro-chart {
    position: relative;
    height: 200px;
}

.food-search-results {
    max-height: 200px;
    overflow-y: auto;
}

.food-item {
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
}

.food-item:hover {
    background-color: #f8f9fa;
}

.meal-type-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.meal-type-icon i {
    font-size: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Üst Başlık -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Beslenme Takibi</h1>
                <div>
                    <button class="btn btn-outline-primary me-2" id="previousDay">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-primary" id="dateSelector">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="selectedDate">Bugün</span>
                    </button>
                    <button class="btn btn-outline-primary ms-2" id="nextDay">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#addMealModal">
                        <i class="fas fa-plus me-2"></i>Öğün Ekle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Günlük Özet -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="nutrition-stat">
                <i class="fas fa-fire"></i>
                <h3 id="totalCalories">0</h3>
                <p class="mb-0">Toplam Kalori</p>
                <div class="progress nutrition-progress">
                    <div class="progress-bar bg-success" id="calorieProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="calorieTarget">Hedef: 2000 kcal</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="nutrition-stat">
                <i class="fas fa-drumstick-bite"></i>
                <h3 id="totalProtein">0g</h3>
                <p class="mb-0">Protein</p>
                <div class="progress nutrition-progress">
                    <div class="progress-bar bg-primary" id="proteinProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="proteinTarget">Hedef: 80g</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="nutrition-stat">
                <i class="fas fa-bread-slice"></i>
                <h3 id="totalCarbs">0g</h3>
                <p class="mb-0">Karbonhidrat</p>
                <div class="progress nutrition-progress">
                    <div class="progress-bar bg-warning" id="carbsProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="carbsTarget">Hedef: 250g</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="nutrition-stat">
                <i class="fas fa-cheese"></i>
                <h3 id="totalFat">0g</h3>
                <p class="mb-0">Yağ</p>
                <div class="progress nutrition-progress">
                    <div class="progress-bar bg-danger" id="fatProgress" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="fatTarget">Hedef: 65g</small>
            </div>
        </div>
    </div>

    <!-- Besin Değerleri Grafiği -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Günlük Besin Değerleri Dağılımı</h5>
                    <div class="macro-chart">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Öğün Dağılımı</h5>
                    <div class="macro-chart">
                        <canvas id="mealDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Öğünler -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Günlük Öğünler</h5>
                    <div id="mealsList">
                        <!-- Öğünler JavaScript ile yüklenecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Öğün Ekleme Modal -->
<div class="modal fade" id="addMealModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Öğün Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMealForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Öğün Türü</label>
                            <select class="form-select" name="meal_type" required>
                                <option value="breakfast">Kahvaltı</option>
                                <option value="lunch">Öğle Yemeği</option>
                                <option value="dinner">Akşam Yemeği</option>
                                <option value="snack">Ara Öğün</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Saat</label>
                            <input type="time" class="form-control" name="time" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Yemek/İçecek Ara</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="foodSearch" 
                                   placeholder="Yemek adı yazın...">
                            <button class="btn btn-outline-secondary" type="button" id="searchFood">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="food-search-results mt-2" id="searchResults" style="display: none;">
                            <!-- Arama sonuçları JavaScript ile doldurulacak -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Seçilen Yiyecekler</label>
                        <div id="selectedFoods">
                            <!-- Seçilen yiyecekler JavaScript ile doldurulacak -->
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Porsiyon (g/ml)</label>
                            <input type="number" class="form-control" name="portion_size" step="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kalori</label>
                            <input type="number" class="form-control" name="calories" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Protein (g)</label>
                            <input type="number" class="form-control" name="protein" step="0.1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Karbonhidrat (g)</label>
                            <input type="number" class="form-control" name="carbs" step="0.1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Yağ (g)</label>
                            <input type="number" class="form-control" name="fat" step="0.1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notlar</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="submit" form="addMealForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Öğünü Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    let selectedDate = new Date();
    let macroChart, mealDistributionChart;

    // Tarih seçiciyi ayarla
    function updateDateDisplay() {
        const today = new Date();
        const isToday = selectedDate.toDateString() === today.toDateString();
        const isYesterday = new Date(today - 86400000).toDateString() === selectedDate.toDateString();
        
        let displayText;
        if (isToday) {
            displayText = 'Bugün';
        } else if (isYesterday) {
            displayText = 'Dün';
        } else {
            displayText = selectedDate.toLocaleDateString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        
        $('#selectedDate').text(displayText);
    }

    // Grafikleri oluştur
    function initializeCharts() {
        // Besin değerleri dağılımı grafiği
        const macroCtx = document.getElementById('macroChart').getContext('2d');
        macroChart = new Chart(macroCtx, {
            type: 'doughnut',
            data: {
                labels: ['Protein', 'Karbonhidrat', 'Yağ'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#0d6efd', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Öğün dağılımı grafiği
        const mealCtx = document.getElementById('mealDistributionChart').getContext('2d');
        mealDistributionChart = new Chart(mealCtx, {
            type: 'pie',
            data: {
                labels: ['Kahvaltı', 'Öğle', 'Akşam', 'Ara Öğün'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#20c997', '#0dcaf0', '#6f42c1', '#fd7e14']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Günlük besin değerlerini yükle
    function loadNutrition() {
        const dateStr = selectedDate.toISOString().split('T')[0];
        $.get(`/api/nutrition/daily/${dateStr}`, function(data) {
            // Toplam değerleri güncelle
            $('#totalCalories').text(data.totals.calories + ' kcal');
            $('#totalProtein').text(data.totals.protein + 'g');
            $('#totalCarbs').text(data.totals.carbs + 'g');
            $('#totalFat').text(data.totals.fat + 'g');

            // İlerleme çubuklarını güncelle
            const calorieProgress = (data.totals.calories / data.targets.calories) * 100;
            const proteinProgress = (data.totals.protein / data.targets.protein) * 100;
            const carbsProgress = (data.totals.carbs / data.targets.carbs) * 100;
            const fatProgress = (data.totals.fat / data.targets.fat) * 100;

            $('#calorieProgress').css('width', Math.min(100, calorieProgress) + '%');
            $('#proteinProgress').css('width', Math.min(100, proteinProgress) + '%');
            $('#carbsProgress').css('width', Math.min(100, carbsProgress) + '%');
            $('#fatProgress').css('width', Math.min(100, fatProgress) + '%');

            // Hedef değerleri güncelle
            $('#calorieTarget').text(`Hedef: ${data.targets.calories} kcal`);
            $('#proteinTarget').text(`Hedef: ${data.targets.protein}g`);
            $('#carbsTarget').text(`Hedef: ${data.targets.carbs}g`);
            $('#fatTarget').text(`Hedef: ${data.targets.fat}g`);

            // Grafikleri güncelle
            macroChart.data.datasets[0].data = [
                data.totals.protein,
                data.totals.carbs,
                data.totals.fat
            ];
            macroChart.update();

            mealDistributionChart.data.datasets[0].data = [
                data.meal_distribution.breakfast || 0,
                data.meal_distribution.lunch || 0,
                data.meal_distribution.dinner || 0,
                data.meal_distribution.snack || 0
            ];
            mealDistributionChart.update();

            // Öğünleri listele
            const mealsList = $('#mealsList');
            mealsList.empty();

            const mealTypes = {
                breakfast: {
                    title: 'Kahvaltı',
                    icon: 'fas fa-coffee'
                },
                lunch: {
                    title: 'Öğle Yemeği',
                    icon: 'fas fa-utensils'
                },
                dinner: {
                    title: 'Akşam Yemeği',
                    icon: 'fas fa-moon'
                },
                snack: {
                    title: 'Ara Öğün',
                    icon: 'fas fa-apple-alt'
                }
            };

            Object.entries(data.meals).forEach(([type, meals]) => {
                const mealSection = `
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="meal-type-icon">
                                <i class="${mealTypes[type].icon}"></i>
                            </div>
                            <h5 class="mb-0">${mealTypes[type].title}</h5>
                        </div>
                        ${meals.map(meal => `
                            <div class="card meal-card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">${meal.food_name}</h6>
                                            <p class="mb-2 text-muted">
                                                ${meal.portion_size ? `${meal.portion_size}g • ` : ''}
                                                ${meal.calories} kcal
                                            </p>
                                            <div class="small text-muted">
                                                Protein: ${meal.protein}g • 
                                                Karb: ${meal.carbs}g • 
                                                Yağ: ${meal.fat}g
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger delete-meal" 
                                                data-id="${meal.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                mealsList.append(mealSection);
            });

            if (Object.keys(data.meals).length === 0) {
                mealsList.html(`
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-utensils fa-2x mb-2"></i>
                        <p>Bu tarihte kayıtlı öğün bulunmuyor</p>
                    </div>
                `);
            }
        });
    }

    // Yemek arama
    let searchTimeout;
    $('#foodSearch').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val();
        
        if (query.length < 2) {
            $('#searchResults').hide();
            return;
        }

        searchTimeout = setTimeout(() => {
            $.get(`/api/foods/search?q=${query}`, function(results) {
                const searchResults = $('#searchResults');
                searchResults.empty();

                results.forEach(food => {
                    const foodItem = `
                        <div class="food-item" data-food='${JSON.stringify(food)}'>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${food.name}</strong>
                                    <div class="small text-muted">
                                        ${food.portion_size}g • ${food.calories} kcal
                                    </div>
                                </div>
                                <div class="text-end small text-muted">
                                    P: ${food.protein}g • K: ${food.carbs}g • Y: ${food.fat}g
                                </div>
                            </div>
                        </div>
                    `;
                    searchResults.append(foodItem);
                });

                searchResults.show();
            });
        }, 300);
    });

    // Yemek seçme
    $(document).on('click', '.food-item', function() {
        const food = $(this).data('food');
        $('input[name="food_name"]').val(food.name);
        $('input[name="portion_size"]').val(food.portion_size);
        $('input[name="calories"]').val(food.calories);
        $('input[name="protein"]').val(food.protein);
        $('input[name="carbs"]').val(food.carbs);
        $('input[name="fat"]').val(food.fat);
        $('#searchResults').hide();
        $('#foodSearch').val('');
    });

    // Öğün ekleme
    $('#addMealForm').submit(function(e) {
        e.preventDefault();
        const formData = {
            meal_type: $('select[name="meal_type"]').val(),
            time: $('input[name="time"]').val(),
            food_name: $('input[name="food_name"]').val(),
            portion_size: parseFloat($('input[name="portion_size"]').val()) || null,
            calories: parseInt($('input[name="calories"]').val()),
            protein: parseFloat($('input[name="protein"]').val()) || null,
            carbs: parseFloat($('input[name="carbs"]').val()) || null,
            fat: parseFloat($('input[name="fat"]').val()) || null,
            notes: $('textarea[name="notes"]').val() || null
        };

        $.ajax({
            url: '/api/nutrition',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#addMealModal').modal('hide');
                $('#addMealForm')[0].reset();
                loadNutrition();
            }
        });
    });

    // Öğün silme
    $(document).on('click', '.delete-meal', function() {
        const id = $(this).data('id');
        if (confirm('Bu öğünü silmek istediğinize emin misiniz?')) {
            $.ajax({
                url: `/api/nutrition/${id}`,
                method: 'DELETE',
                success: loadNutrition
            });
        }
    });

    // Tarih navigasyonu
    $('#previousDay').click(function() {
        selectedDate.setDate(selectedDate.getDate() - 1);
        updateDateDisplay();
        loadNutrition();
    });

    $('#nextDay').click(function() {
        selectedDate.setDate(selectedDate.getDate() + 1);
        updateDateDisplay();
        loadNutrition();
    });

    // Başlangıç yüklemeleri
    initializeCharts();
    updateDateDisplay();
    loadNutrition();

    // Varsayılan saat değerini ayarla
    const now = new Date();
    $('input[name="time"]').val(
        `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
    );
});
</script>
{% endblock %} 