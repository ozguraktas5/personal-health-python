{% extends "base.html" %}

{% block title %}Reports - Health Tracker{% endblock %}

{% block extra_css %}
<style>
.report-card {
    transition: transform 0.2s;
    border-radius: 1rem;
    overflow: hidden;
}

.report-card:hover {
    transform: translateY(-5px);
}

.progress-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.progress-good {
    background-color: #d4edda;
    color: #198754;
}

.progress-warning {
    background-color: #fff3cd;
    color: #ffc107;
}

.progress-bad {
    background-color: #f8d7da;
    color: #dc3545;
}

.goal-progress {
    height: 8px;
    border-radius: 4px;
    margin-top: 0.5rem;
}

.report-chart {
    height: 300px;
    margin: 1rem 0;
}

.date-range-selector {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
}

.summary-stat {
    text-align: center;
    padding: 1.5rem;
    border-radius: 1rem;
    background: #f8f9fa;
    margin-bottom: 1rem;
}

.summary-stat i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #198754;
}

.summary-stat .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.comparison-arrow {
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

.comparison-better {
    color: #198754;
}

.comparison-worse {
    color: #dc3545;
}

.comparison-same {
    color: #6c757d;
}

.achievement-badge {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
}

.achievement-badge i {
    font-size: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Üst Başlık -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Health Reports</h1>
                <div class="d-flex gap-3">
                    <div class="date-range-selector" id="dateRange">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span>Last 30 Days</span>
                    </div>
                    <button class="btn btn-primary" id="exportReport">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet İstatistikler -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="summary-stat">
                <i class="fas fa-weight"></i>
                <div class="stat-value" id="weightChange">0 kg</div>
                <p class="mb-0">Weight Change</p>
                <small class="text-muted">
                    Compared to previous period
                    <span class="comparison-arrow">
                        <i class="fas fa-arrow-right comparison-same"></i>
                    </span>
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <i class="fas fa-fire"></i>
                <div class="stat-value" id="avgCalories">0 kcal</div>
                <p class="mb-0">Average Calories</p>
                <small class="text-muted">
                    Daily average intake
                    <span class="comparison-arrow">
                        <i class="fas fa-arrow-right comparison-same"></i>
                    </span>
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <i class="fas fa-running"></i>
                <div class="stat-value" id="exerciseTime">0 dk</div>
                <p class="mb-0">Exercise Duration</p>
                <small class="text-muted">
                    Total duration
                    <span class="comparison-arrow">
                        <i class="fas fa-arrow-right comparison-same"></i>
                    </span>
                </small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-stat">
                <i class="fas fa-trophy"></i>
                <div class="stat-value" id="achievedGoals">0</div>
                <p class="mb-0">Goal Success</p>
                <small class="text-muted">
                    Completed goals
                    <span class="comparison-arrow">
                        <i class="fas fa-arrow-right comparison-same"></i>
                    </span>
                </small>
            </div>
        </div>
    </div>

    <!-- Detaylı Analizler -->
    <div class="row">
        <!-- Kilo ve VKİ Analizi -->
        <div class="col-md-6 mb-4">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Weight and BMI Analysis</h5>
                    <div class="report-chart">
                        <canvas id="weightBMIChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <h6>Key Points</h6>
                        <ul class="list-unstyled" id="weightAnalysis">
                            <!-- JavaScript ile doldurulacak -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Beslenme Analizi -->
        <div class="col-md-6 mb-4">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Nutrition Analysis</h5>
                    <div class="report-chart">
                        <canvas id="nutritionChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <h6>Nutrition Summary</h6>
                        <ul class="list-unstyled" id="nutritionAnalysis">
                            <!-- JavaScript ile doldurulacak -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Egzersiz Analizi -->
        <div class="col-md-6 mb-4">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Exercise Analysis</h5>
                    <div class="report-chart">
                        <canvas id="exerciseChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <h6>Activity Summary</h6>
                        <ul class="list-unstyled" id="exerciseAnalysis">
                            <!-- JavaScript ile doldurulacak -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hedef Takibi -->
        <div class="col-md-6 mb-4">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Goal Tracking</h5>
                    <div id="goalsList">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Başarılar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Achievements</h5>
                    <div class="row" id="achievementsList">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Öneriler -->
    <div class="row">
        <div class="col-12">
            <div class="card report-card">
                <div class="card-body">
                    <h5 class="card-title">Personalized Recommendations</h5>
                    <div class="row" id="recommendationsList">
                        <!-- JavaScript ile doldurulacak -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    let weightBMIChart, nutritionChart, exerciseChart;
    let currentDateRange = '30d'; // Varsayılan son 30 gün

    // Grafikleri başlat
    function initializeCharts() {
        // Kilo ve VKİ grafiği
        const weightCtx = document.getElementById('weightBMIChart').getContext('2d');
        weightBMIChart = new Chart(weightCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Weight (kg)',
                        data: [],
                        borderColor: '#198754',
                        yAxisID: 'y'
                    },
                    {
                        label: 'BMI',
                        data: [],
                        borderColor: '#0dcaf0',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left'
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Beslenme grafiği
        const nutritionCtx = document.getElementById('nutritionChart').getContext('2d');
        nutritionChart = new Chart(nutritionCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Calories (kcal)',
                        data: [],
                        backgroundColor: '#198754'
                    },
                    {
                        label: 'Protein (g)',
                        data: [],
                        backgroundColor: '#0dcaf0'
                    },
                    {
                        label: 'Carbohydrates (g)',
                        data: [],
                        backgroundColor: '#ffc107'
                    },
                    {
                        label: 'Fat (g)',
                        data: [],
                        backgroundColor: '#dc3545'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Egzersiz grafiği
        const exerciseCtx = document.getElementById('exerciseChart').getContext('2d');
        exerciseChart = new Chart(exerciseCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Duration (minutes)',
                    data: [],
                    backgroundColor: '#198754'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Rapor verilerini yükle
    function loadReportData() {
        $.get(`/api/reports/${currentDateRange}`, function(data) {
            // Özet istatistikleri güncelle
            updateSummaryStats(data.summary);

            // Grafikleri güncelle
            updateCharts(data.charts);

            // Analizleri güncelle
            updateAnalysis(data.analysis);

            // Hedefleri güncelle
            updateGoals(data.goals);

            // Başarıları güncelle
            updateAchievements(data.achievements);

            // Önerileri güncelle
            updateRecommendations(data.recommendations);
        });
    }

    // Özet istatistikleri güncelle
    function updateSummaryStats(summary) {
        // Kilo değişimi
        $('#weightChange').text(summary.weight_change > 0 ? 
            `+${summary.weight_change} kg` : `${summary.weight_change} kg`);
        updateComparisonArrow('#weightChange', summary.weight_change_trend);

        // Ortalama kalori
        $('#avgCalories').text(`${summary.avg_calories} kcal`);
        updateComparisonArrow('#avgCalories', summary.calories_trend);

        // Egzersiz süresi
        $('#exerciseTime').text(`${summary.total_exercise} dk`);
        updateComparisonArrow('#exerciseTime', summary.exercise_trend);

        // Hedef başarısı
        $('#achievedGoals').text(summary.achieved_goals);
        updateComparisonArrow('#achievedGoals', summary.goals_trend);
    }

    // Karşılaştırma oklarını güncelle
    function updateComparisonArrow(selector, trend) {
        const arrow = $(selector).siblings('small').find('.comparison-arrow i');
        arrow.removeClass('fa-arrow-up fa-arrow-down fa-arrow-right')
             .removeClass('comparison-better comparison-worse comparison-same');

        if (trend > 0) {
            arrow.addClass('fa-arrow-up comparison-better');
        } else if (trend < 0) {
            arrow.addClass('fa-arrow-down comparison-worse');
        } else {
            arrow.addClass('fa-arrow-right comparison-same');
        }
    }

    // Grafikleri güncelle
    function updateCharts(chartData) {
        // Kilo ve VKİ grafiği
        weightBMIChart.data.labels = chartData.dates;
        weightBMIChart.data.datasets[0].data = chartData.weight;
        weightBMIChart.data.datasets[1].data = chartData.bmi;
        weightBMIChart.update();

        // Beslenme grafiği
        nutritionChart.data.labels = chartData.nutrition_dates;
        nutritionChart.data.datasets[0].data = chartData.calories;
        nutritionChart.data.datasets[1].data = chartData.protein;
        nutritionChart.data.datasets[2].data = chartData.carbs;
        nutritionChart.data.datasets[3].data = chartData.fat;
        nutritionChart.update();

        // Egzersiz grafiği
        exerciseChart.data.labels = chartData.exercise_dates;
        exerciseChart.data.datasets[0].data = chartData.exercise_duration;
        exerciseChart.update();
    }

    // Analizleri güncelle
    function updateAnalysis(analysis) {
        // Kilo analizi
        const weightList = $('#weightAnalysis');
        weightList.empty();
        analysis.weight.forEach(item => {
            weightList.append(`
                <li class="mb-2">
                    <i class="fas ${item.icon} me-2 ${item.type}"></i>
                    ${item.text}
                </li>
            `);
        });

        // Beslenme analizi
        const nutritionList = $('#nutritionAnalysis');
        nutritionList.empty();
        analysis.nutrition.forEach(item => {
            nutritionList.append(`
                <li class="mb-2">
                    <i class="fas ${item.icon} me-2 ${item.type}"></i>
                    ${item.text}
                </li>
            `);
        });

        // Egzersiz analizi
        const exerciseList = $('#exerciseAnalysis');
        exerciseList.empty();
        analysis.exercise.forEach(item => {
            exerciseList.append(`
                <li class="mb-2">
                    <i class="fas ${item.icon} me-2 ${item.type}"></i>
                    ${item.text}
                </li>
            `);
        });
    }

    // Hedefleri güncelle
    function updateGoals(goals) {
        const goalsList = $('#goalsList');
        goalsList.empty();

        goals.forEach(goal => {
            const progress = (goal.current / goal.target) * 100;
            const progressClass = progress >= 100 ? 'bg-success' : 
                                progress >= 75 ? 'bg-info' :
                                progress >= 50 ? 'bg-warning' : 'bg-danger';

            goalsList.append(`
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0">${goal.title}</h6>
                            <small class="text-muted">${goal.description}</small>
                        </div>
                        <div class="progress-indicator ${goal.status}">
                            <i class="fas ${goal.icon}"></i>
                        </div>
                    </div>
                    <div class="progress goal-progress">
                        <div class="progress-bar ${progressClass}" 
                             style="width: ${Math.min(100, progress)}%"></div>
                    </div>
                    <small class="text-muted">
                        ${goal.current} / ${goal.target} ${goal.unit}
                    </small>
                </div>
            `);
        });
    }

    // Başarıları güncelle
    function updateAchievements(achievements) {
        const achievementsList = $('#achievementsList');
        achievementsList.empty();

        achievements.forEach(achievement => {
            achievementsList.append(`
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="text-center">
                        <div class="achievement-badge mx-auto">
                            <i class="fas ${achievement.icon}"></i>
                        </div>
                        <h6>${achievement.title}</h6>
                        <small class="text-muted">${achievement.description}</small>
                    </div>
                </div>
            `);
        });
    }

    // Önerileri güncelle
    function updateRecommendations(recommendations) {
        const recommendationsList = $('#recommendationsList');
        recommendationsList.empty();

        recommendations.forEach(rec => {
            recommendationsList.append(`
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas ${rec.icon} me-2"></i>
                                ${rec.title}
                            </h6>
                            <p class="card-text">${rec.description}</p>
                        </div>
                    </div>
                </div>
            `);
        });
    }

    // Tarih aralığı seçimi
    $('#dateRange').click(function() {
        // Burada bir tarih aralığı seçici modal'ı açılabilir
        // Şimdilik sadece döngüsel olarak değiştirelim
        const ranges = {
            '7d': 'Last 7 Days',
            '30d': 'Last 30 Days',
            '90d': 'Last 90 Days',
            '180d': 'Last 180 Days'
        };

        const currentText = $(this).find('span').text();
        const keys = Object.keys(ranges);
        const currentIndex = Object.values(ranges).indexOf(currentText);
        const nextIndex = (currentIndex + 1) % keys.length;
        
        currentDateRange = keys[nextIndex];
        $(this).find('span').text(ranges[currentDateRange]);
        
        loadReportData();
    });

    // Raporu indir
    $('#exportReport').click(function() {
        window.location.href = `/api/reports/${currentDateRange}/export`;
    });

    // Başlangıç yüklemeleri
    initializeCharts();
    loadReportData();
});
</script>
{% endblock %} 