{% extends "base.html" %}

{% block title %}Health Metrics - Health Tracker{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    transition: transform 0.2s;
    border-radius: 1rem;
    overflow: hidden;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-icon {
    font-size: 24px;
    margin-bottom: 0.5rem;
    color: #198754;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-trend {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.trend-up {
    color: #dc3545;
}

.trend-down {
    color: #198754;
}

.trend-stable {
    color: #6c757d;
}

.metric-chart {
    height: 300px;
    margin-top: 1rem;
}

.bmi-scale {
    height: 2rem;
    border-radius: 1rem;
    background: linear-gradient(to right, 
        #198754 0%, /* Normal */
        #198754 18.5%,
        #ffc107 18.5%, /* Underweight */
        #ffc107 25%,
        #198754 25%, /* Normal */
        #198754 30%,
        #fd7e14 30%, /* Overweight */
        #fd7e14 35%,
        #dc3545 35% /* Obese */
    );
    position: relative;
    margin: 2rem 0;
}

.bmi-marker {
    position: absolute;
    width: 2px;
    height: 2rem;
    background-color: #000;
    transform: translateX(-50%);
}

.bmi-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: #6c757d;
}

.measurement-history {
    max-height: 400px;
    overflow-y: auto;
}

.measurement-item {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.2s;
}

.measurement-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Health Metrics</h1>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMetricModal">
                        <i class="fas fa-plus me-2"></i>New Measurement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Basic Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-weight metric-icon"></i>
                    <h6 class="card-subtitle mb-2 text-muted">Weight</h6>
                    <div class="metric-value" id="currentWeight">0 kg</div>
                    <div class="metric-trend">
                        <span id="weightTrend">0 kg</span>
                        <i class="fas fa-arrow-right trend-stable"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-ruler-vertical metric-icon"></i>
                    <h6 class="card-subtitle mb-2 text-muted">Height</h6>
                    <div class="metric-value" id="currentHeight">0 cm</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-calculator metric-icon"></i>
                    <h6 class="card-subtitle mb-2 text-muted">Body Mass Index</h6>
                    <div class="metric-value" id="currentBMI">0</div>
                    <div class="metric-trend">
                        <span id="bmiStatus">Normal</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-heartbeat metric-icon"></i>
                    <h6 class="card-subtitle mb-2 text-muted">Heart Rate</h6>
                    <div class="metric-value" id="currentHeartRate">0 bpm</div>
                    <div class="metric-trend">
                        <span id="heartRateTrend">0 bpm</span>
                        <i class="fas fa-arrow-right trend-stable"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BMI Scale -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Body Mass Index Scale</h5>
                    <div class="bmi-scale">
                        <div class="bmi-marker" id="bmiMarker" style="left: 0%"></div>
                    </div>
                    <div class="bmi-labels">
                        <span>Underweight (<18.5)</span>
                        <span>Normal (18.5-24.9)</span>
                        <span>Overweight (25-29.9)</span>
                        <span>Obese (>30)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and History -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Measurement History</h5>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary active" data-metric="weight">
                                Weight
                            </button>
                            <button class="btn btn-outline-secondary" data-metric="bmi">
                                BMI
                            </button>
                            <button class="btn btn-outline-secondary" data-metric="heartRate">
                                Heart Rate
                            </button>
                        </div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="metricsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Measurements</h5>
                    <div class="measurement-history" id="measurementHistory">
                        <!-- Measurements will be loaded via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Measurement Modal -->
<div class="modal fade" id="addMetricModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMetricForm">
                    <div class="mb-3">
                        <label class="form-label">Measurement Type</label>
                        <select class="form-select" name="metric_type" required>
                            <option value="weight">Weight</option>
                            <option value="height">Height</option>
                            <option value="heart_rate">Heart Rate</option>
                            <option value="blood_pressure">Blood Pressure</option>
                        </select>
                    </div>

                    <div class="mb-3" id="weightField">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" name="weight" step="0.1">
                    </div>

                    <div class="mb-3" id="heightField" style="display: none;">
                        <label class="form-label">Height (cm)</label>
                        <input type="number" class="form-control" name="height" step="1">
                    </div>

                    <div class="mb-3" id="heartRateField" style="display: none;">
                        <label class="form-label">Heart Rate (bpm)</label>
                        <input type="number" class="form-control" name="heart_rate" step="1">
                    </div>

                    <div class="row mb-3" id="bloodPressureField" style="display: none;">
                        <div class="col-6">
                            <label class="form-label">Systolic</label>
                            <input type="number" class="form-control" name="systolic" step="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Diastolic</label>
                            <input type="number" class="form-control" name="diastolic" step="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Date and Time</label>
                        <input type="datetime-local" class="form-control" name="measured_at" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addMetricForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save Measurement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    let metricsChart;
    let currentMetric = 'weight';

    // Initialize charts
    function initializeCharts() {
        const ctx = document.getElementById('metricsChart').getContext('2d');
        metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Weight (kg)',
                    data: [],
                    borderColor: '#198754',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Calculate BMI
    function calculateBMI(weight, height) {
        const heightInMeters = height / 100;
        return (weight / (heightInMeters * heightInMeters)).toFixed(1);
    }

    // Get BMI status
    function getBMIStatus(bmi) {
        if (bmi < 18.5) return 'Underweight';
        if (bmi < 25) return 'Normal';
        if (bmi < 30) return 'Overweight';
        return 'Obese';
    }

    // Update BMI marker position
    function updateBMIMarker(bmi) {
        let position;
        if (bmi < 18.5) {
            position = (bmi / 18.5) * 18.5;
        } else if (bmi < 25) {
            position = 18.5 + ((bmi - 18.5) / 6.5) * 6.5;
        } else if (bmi < 30) {
            position = 25 + ((bmi - 25) / 5) * 5;
        } else {
            position = Math.min(35 + ((bmi - 30) / 5) * 5, 100);
        }
        $('#bmiMarker').css('left', `${position}%`);
    }

    // Load metrics
    function loadMetrics() {
        $.get('/api/metrics/latest', function(data) {
            // Weight
            $('#currentWeight').text(data.weight ? `${data.weight} kg` : '-- kg');
            if (data.weight_trend) {
                const trend = data.weight_trend;
                $('#weightTrend').text(`${Math.abs(trend)} kg`);
                if (trend > 0) {
                    $('#weightTrend').next('i')
                        .removeClass('fa-arrow-right trend-stable')
                        .addClass('fa-arrow-up trend-up');
                } else if (trend < 0) {
                    $('#weightTrend').next('i')
                        .removeClass('fa-arrow-right trend-stable')
                        .addClass('fa-arrow-down trend-down');
                }
            }

            // Height
            $('#currentHeight').text(data.height ? `${data.height} cm` : '-- cm');

            // BMI
            if (data.weight && data.height) {
                const bmi = calculateBMI(data.weight, data.height);
                $('#currentBMI').text(bmi);
                $('#bmiStatus').text(getBMIStatus(bmi));
                updateBMIMarker(bmi);
            }

            // Heart Rate
            $('#currentHeartRate').text(data.heart_rate ? `${data.heart_rate} bpm` : '-- bpm');
            if (data.heart_rate_trend) {
                const trend = data.heart_rate_trend;
                $('#heartRateTrend').text(`${Math.abs(trend)} bpm`);
                if (trend > 0) {
                    $('#heartRateTrend').next('i')
                        .removeClass('fa-arrow-right trend-stable')
                        .addClass('fa-arrow-up trend-up');
                } else if (trend < 0) {
                    $('#heartRateTrend').next('i')
                        .removeClass('fa-arrow-right trend-stable')
                        .addClass('fa-arrow-down trend-down');
                }
            }
        });

        // Load chart data
        $.get(`/api/metrics/history/${currentMetric}`, function(data) {
            metricsChart.data.labels = data.dates;
            metricsChart.data.datasets[0].data = data.values;
            
            const metricLabels = {
                weight: 'Weight (kg)',
                bmi: 'BMI',
                heartRate: 'Heart Rate (bpm)'
            };
            metricsChart.data.datasets[0].label = metricLabels[currentMetric];
            
            metricsChart.update();
        });

        // Load recent measurements
        $.get('/api/metrics/recent', function(measurements) {
            const history = $('#measurementHistory');
            history.empty();

            measurements.forEach(m => {
                const date = new Date(m.measured_at).toLocaleDateString('en-US', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let valueText;
                switch (m.type) {
                    case 'weight':
                        valueText = `${m.value} kg`;
                        break;
                    case 'height':
                        valueText = `${m.value} cm`;
                        break;
                    case 'heart_rate':
                        valueText = `${m.value} bpm`;
                        break;
                    case 'blood_pressure':
                        valueText = `${m.systolic}/${m.diastolic} mmHg`;
                        break;
                }

                const item = `
                    <div class="measurement-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${m.type_label}</h6>
                                <p class="mb-1">${valueText}</p>
                                <small class="text-muted">${date}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger delete-measurement" 
                                    data-id="${m.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${m.notes ? `<small class="d-block mt-2 text-muted">${m.notes}</small>` : ''}
                    </div>
                `;
                history.append(item);
            });
        });
    }

    // Update form fields when measurement type changes
    $('select[name="metric_type"]').change(function() {
        const type = $(this).val();
        $('#weightField, #heightField, #heartRateField, #bloodPressureField').hide();
        $(`#${type}Field`).show();
    });

    // Change chart type
    $('.btn-group .btn').click(function() {
        $('.btn-group .btn').removeClass('active');
        $(this).addClass('active');
        currentMetric = $(this).data('metric');
        loadMetrics();
    });

    // Add new measurement
    $('#addMetricForm').submit(function(e) {
        e.preventDefault();
        const type = $('select[name="metric_type"]').val();
        const formData = {
            type: type,
            measured_at: $('input[name="measured_at"]').val(),
            notes: $('textarea[name="notes"]').val() || null
        };

        switch (type) {
            case 'weight':
                formData.value = parseFloat($('input[name="weight"]').val());
                break;
            case 'height':
                formData.value = parseInt($('input[name="height"]').val());
                break;
            case 'heart_rate':
                formData.value = parseInt($('input[name="heart_rate"]').val());
                break;
            case 'blood_pressure':
                formData.systolic = parseInt($('input[name="systolic"]').val());
                formData.diastolic = parseInt($('input[name="diastolic"]').val());
                break;
        }

        $.ajax({
            url: '/api/metrics',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                $('#addMetricModal').modal('hide');
                $('#addMetricForm')[0].reset();
                loadMetrics();
            }
        });
    });

    // Delete measurement
    $(document).on('click', '.delete-measurement', function() {
        const id = $(this).data('id');
        if (confirm('Are you sure you want to delete this measurement?')) {
            $.ajax({
                url: `/api/metrics/${id}`,
                method: 'DELETE',
                success: loadMetrics
            });
        }
    });

    // Set default date/time value
    const now = new Date();
    $('input[name="measured_at"]').val(
        now.toISOString().slice(0, 16)
    );

    // Initial loads
    initializeCharts();
    loadMetrics();
});
</script>
{% endblock %} 